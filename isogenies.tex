\documentclass{article}

\bibliographystyle{amsalpha}
\include{macros}
\usepackage{microtype}
\usepackage{tikz-cd}
\renewcommand{\q}{\mathfrak{q}}
\newcommand{\f}{\mathfrak{f}}
\newcommand{\I}{\mathcal{I}}
\newcommand{\odd}{\mathrm{odd}}
\tikzset{labl/.style={anchor=south, rotate=90, inner sep=.5mm}}

\begin{document}

\tableofcontents
    
\section{Enumerating Isogenies of Prime Level Subvarieties}

The goal of this section is, under mild conditions, to give an algorithm to
enumerate the odd-degree $\QQ$-isogeny class of simple abelian subvarieties
$A_f$ of $J_0(N)$ for $N$ prime, up to isomorphism. Given a $\QQ$-isogeny
$\psi:A_f\to A'$ with kernel $K$, so
\[
    0 \to K \to A_f \overset{\psi}{\to} A' \to 0.
\]
Since the isogeny is defined over $\QQ$, $K$ is a finite $G_\QQ$-submodule of
$A_f(\QQbar)$ which determines $A'$, up to isomorphism. Conversely, for every
$G_\QQ$-submodule $K$ of $A_f(\QQbar)$, there exists an isogeny of $A_f$ with
kernel $K$. Therefore, we will enumerate the odd-degree isogeny class of $A_f$,
by enumerating the finite odd-order $G_\QQ$-submodules of $A_f(\QQbar)$, up to
isomorphism of the image of the corresponding isogeny. 

We now fix notation, terminology, assumptions.
\begin{itemize}
    \item{} [Isomorphisms and Isogenies]
        Unless otherwise stated, all isomorphisms and isogenies are defined
        over $\QQ$.
    \item{} [Jacobian notation]
        Let $J = J_0(N)$ with $N$ prime. To avoid trivialities, assume $\dim
        J>0$ or equivalently, $N=11$ or $N\geq 17$. Let $\TT$ be the Hecke
        algebra of $J$ and $\I\subseteq \TT$ be the Eisenstein ideal.
    \item{} [Abelian subvariety notation]
        Let $A=A_f\subseteq J$ be a simple abelian subvariety of $J$. We will
        fix a single simple abelian subvariety $A$ and its isogeny class will
        be our object of study. We have that $A$ is $\TT$-invariant so let
        $\TT_A$ be the image of $\TT$ in $\End(A)$ and $\I_A$ be the image of
        the Eisenstein ideal in $\End(A)$. 
    \item{} [Number theory of $\TT_A$ notation] 
        Let $K_f$ be the Hecke eigenvalue field of $f$ so $K_f$ is a number
        field of degree equal to $\dim A$. Moreover, $\TT_A$ is isomorphic to
        an order in $K_f$. We will implicitly fix some embedding of $\TT_A$ and
        treat $\TT_A$ as a subset of $K_f$. Let $\O_K$ be the ring of integers
        of $K_f$ and $\f$ be the conductor of $\O_K$ over $\TT_A$.
    \item{} [Galois-Hecke group ring notation]
        Let $G_\QQ=\Gal(\QQbar/\QQ)$. The Hecke operators are defined over
        $\QQ$, so $\TT_A$ commutes with $G_\QQ$ and we can form the group ring
        $R=\TT_A[G_\QQ]$.
    \item{} [Equivalence relation notation]
        For finite $G_\QQ$-submodules $M$ and $M'$, we define a relationship
        $M\sim M'$ if and only if $A/M \isom A/M'$. For any $G_\QQ$-submodule
        $P$ of $A(\QQbar)$, let $\M(P)$ be set of equivalence classes of finite
        $G_\QQ$-submodules of $A(\QQbar)_\odd$ with a representative that is a
        submodule of $P$. So the goal of this chapter can be restated as
        enumerating a set of representatives of $\M(A(\QQbar)_\odd)$.
    \item{} [Sets of primes notation]
        Let $S_0=\{\m\in \Spec\TT[\frac 12]: \m \nmid
        \mathfrak{f}\mathcal{I}\}$ and $S_1 = \Spec\TT[\frac 12]\setminus S_0$.
        The best fact about $S_0$ is that its elements are invertible and the
        best fact about $S_1$ is that it is finite.
    \item{} [$S_0$ and $S_1$ decomposition notation]
        For an $R$-module $M$ of $A(\QQbar)_\odd$, let $M_{S_i}$ be the largest
        $R$-submodule of $M$ supported on $S_i$ so $M_{S_i}=M[\prod_{\p\in S_i}
        \p^\infty]$. Observe that $M = M_{S_0}\oplus M_{S_1}$.
    \item{} [Odd]
        A module is said to be odd if it is finite with odd cardinality.
\end{itemize}

The goal of this section is Algorithm~\ref{alg:odd_isogeny_class} which
enumerates the odd isogeny class of $A$ when $\TT_A$ is integrally closed. This
occurs THIS OFTEN TODO!!!

The idea will be as follows. Let $M$ be a odd $G$-submodule of
$A(\QQbar)_\odd$. In
subsection~\ref{sub:finite_odd_order_galois_modules_are_hecke}, we will show
that $M$ is an $R$-module. This is useful because the $\TT$-structure is more
easily understood than the $G_\QQ$-structure. For example, we are now able to
talk about the support of $M$ as a $\TT$-module. Using Proposition~\ref{}, we
can give an explicit set $S$ such that every odd $G$-module is
equivalent to one supported on $S$. In other words,
$\M(A(\QQbar)_\odd)=\M(A[Q^\infty])$, where $Q$ is some ideal with
$\Supp(Q)=S$. Using Algorithm~\ref{}, we can compute the $G$-submodules of
$\M(A[Q^r])$ for any $r$ and Proposition~\ref{} produces a $k$ such that
$\M(A[Q^k])=\M(A[Q^\infty])=\M(A(\QQbar))$.

In summary, we have the following algorithm with forward references.
\begin{algorithm}{Odd isogeny class}%
    \label{alg:odd_isogeny_class}
    Let $A$ be a simple abelian subvariety with $\TT_A$ integrally closed. This
    algorithm will enumerate the odd isogeny class of $A$ by giving a set of
    representatives of $\M(A(\QQbar)_\odd)$.
    \begin{enumerate}
        \item{} [Class group representatives]
            Compute a set of odd integral representatives $\{\q_i\}$ of
            $\Cl(\TT_A)$. Let $Q = (\prod \q_i)(\prod_{\p\in S_1} \p)$. 
        \item{} [Initialize search]
            Set $r=1$ and $X_{r-1}=\emptyset$.
        \item{} [$G$-submodules of $A[Q^r]$]
            Use Algorithm~\ref{} to give a set, $X_r$, of representatives for
            $\M(A[Q^r])$.
        \item{} [Done?]
            By Proposition~\ref{}, if for all $x\in X_r$, $x\sim y$ for some
            $y\in X_{r-1}$, then $X_r$ is a set of representatives for
            $\M(A(\QQbar)_\odd)$. If this is not the case, increment $r$ and
            repeat the last step.
        \item{} [Quotient and output]
            Output $A/x$ for $x\in X_r$.
    \end{enumerate}
\end{algorithm}

\begin{example}[A Non-Eisenstein isogeny]
    Let $A,B,C$ be the simple abelian subvarieties of $J_0(499)$ in decreasing
    dimension. Let $K$ be the Hecke
    eigenvalue field of the newform associated to $A$. Using Sage, we
    determine that $[\O_K:\TT_A]=3$. Moreover, by a theorem of Mazur~\cite{},
    $\TT=\End(J_0(499)$. There is a 2-isogeny from $A\times (B+C)$ to
    $J_0(499)$, therefore, $\TT_A=\End(A)$. So by a theorem of Shimura, there
    is a rational 3-isogeny from $A\to A'$ with $\End(A')=\O_K$. This isogeny
    is not Eisenstein as $3$ does not dividing $\# \TT/\I = \mathrm{num}
    \left(\frac{N-1}{12}\right)$.
\end{example}

\subsection{Finite odd-order Galois Modules are Hecke}%
\label{sub:finite_odd_order_galois_modules_are_hecke}

The goal of this subsection is to prove every finite $G$-submodule $M$ of
$A(\QQbar)_\odd$ is a Hecke module (Theorem~\ref{thm:G_modules_are_Hecke}).
The Galois action of $J(\QQbar)$ has been extensively studied by
Mazur~\cite{mazur:eisenstein}, so we weaken our hypothesis to $M$ a
$G$-submodule of $J(\QQbar)_\odd$. 

It suffices to prove $M$ is a $\TT$-module for each $G$-composition factor $V$
of $M[\ell^\infty]$ for $\ell>2$. The irreducibility of $V$ implies that it is
$\ell$-torsion. A theorem of Ribet~\cite[Proposition 2]{ribet:mult_p_finite}
shows that $\TT/\ell \TT$ is generated by $T_p$ for primes $p\nmid \ell N$.
By~\cite[\S 14]{mazur:eisenstein}, these are exactly the unramified primes of
the Galois representation of $V$. We then reduce modulo these unramified primes
and use Eichler-Shimura to deduce the $\TT$-stability of $V$ from its
$G$-stability.

\begin{lemma}\label{lemma:cherry_street}
    Let $V$ be an irreducible $R$-subquotient of $J[\ell^\infty]$. Then
    $\Ann_\TT V$ is a maximal ideal $\m$ of $\TT$. Moreover, $V$ is
    $R$-isomorphic to a subquotient of $J[\m]$.
\end{lemma}
\begin{proof}
    Let $I=\Ann_\TT V$. Since $\ell\in I$, $\TT/I$ is a finite ring so it
    suffices to show that $I$ is prime. Let $a,b\in \TT\setminus I$. Since $G$
    commutes with $\TT$, $aV$ and $bV$ are both $R$-submodules of $V$. By
    $R$-irreducibility of $V$, $aV=bV=V$. Consequently, $abV=V$ so $ab\notin I$
    and $I$ is prime.
    % TODO: fill in
\end{proof}

\begin{theorem}[Mazur]\label{thm:irreducible_G_sub}
    Let $V$ be an irreducible $G$-subquotient of $J[\ell^\infty]$. Then either
    \begin{itemize}
        \item
            $V\cong_G \ZZ/\ell$ or $V\cong_G \mu_\ell$ and is unramified away
            from $\ell$, or
        \item 
            $V\cong_G J[\m]$ for some non-Eisenstein maximal $\m$ and is
            unramified away from $\ell N$.
    \end{itemize}
    In any case, $V$ is unramified away from $\ell N$.
\end{theorem}
\begin{proof}
    This is essentially~\cite[\S 14]{mazur:eisenstein}.

    Let $V$ be an irreducible $R$-module. By Lemma~\ref{lemma:cherry_street},
    the annihilator of $V$ in $\TT$ is a maximal ideal $\m$ of $\TT$ and $V$ is
    $R$-isomorphic to a subquotient of $J[\m]$. Then $V$ is $R$-isomorphic to a
    subquotient of $J[\m]$. Either $\m$ is Eisenstein or it's not.
    \begin{enumerate}
        \item
            If $\m$ is Eisenstein, then the action of $\TT$ factors through
            $\ZZ$, so $V$ is irreducible as a $G$-module. By~\cite[Proposition
            14.1]{mazur:eisenstein}, $J[\m]$ has a $G$-composition series
            consisting of $\ZZ/\ell$ and $\mu_\ell$ (this is what Mazur calls
            admissible) so $V$ is isomorphic as $G$-module to either $\ZZ/\ell$
            or $\mu_\ell$.
        \item
            If $\m$ is non-Eisenstein, then by~\cite[Proposition
            14.2]{mazur:eisenstein} $J[\m]$ is irreducible as a $G$-module so
            $V\cong_G J[\m]$, which is unramified away from $\ell N$
            by~\cite[Theorem 6.7]{deligne-serre}. Hence, $V\cong_G J[\m]$ is
            irreducible as a $G$-module. By~\cite[Theorem 6.7]{deligne-serre},
            $V$ is unramified away $\ell N$.
    \end{enumerate}
    This proves that any $R$-composition series of $J[\ell]$ is also a
    $G$-composition series of $J[\ell]$. The conclusion now follows from the
    Jordan-Holder Theorem.
\end{proof} 

\begin{theorem}\label{thm:G_modules_are_Hecke}
    Suppose $M$ is an odd $G$-module. Then $M$ is $\TT$-stable so $M$ is
    an $R$-module.
\end{theorem}
\begin{proof}
    It suffices to prove this for each $\ell$-primary part. Let $\ell>2$ and
    assume $M\subseteq J[\ell^\infty]$. Let
    \[
        0 = M_0 \subsetneq \ldots \subsetneq M_n = M
    \]
    be an $G$-composition series of $M$ with composition factors $X_i =
    M_i/M_{i-1}$. We proceed by induction on on $n$ with the base
    case being the trivial $n=0$ case. 
    
    Assume $M_{s-1}$ is an $R$-module. We will show $M_s$ is an $R$-module.
    Since $M_{s-1}$ is an $R$-module, for each $t\in \TT$, we have a
    well-defined map $t:X_s\to J(\QQbar)/M_{s-1}$. The goal is to show
    $t(X_s)\subseteq X_s$. Then by~\cite[Proposition 2]{ribet:mult_p_finite},
    $\TT/\ell \TT$ is generated by $T_p$ for $p\nmid \ell N$ so it suffices to
    show $T_p(X_s)\subseteq X_s$ for prime $p\nmid \ell N$.

    Fix a prime $p\nmid \ell N$. By Theorem~\ref{thm:irreducible_G_sub},
    the Galois representation associated to $X_s$ is unramified away from $\ell
    N$ so let $\Frob_p$ be a choice of Frobenius of a prime over $p$. By the
    proof of~\cite[Lemma 12.6.2]{ribet-stein:mod}, the reduction map induces an
    isomorphism
    \[
        \tau:J(\QQbar)[\ell^\infty] \riso J_{/\F_p} (\Fpbar)[\ell^\infty].
    \]
    Under this isomorphism, we have that $\Frob_p$ corresponds to the Frobenius
    $F$ in $J_{/\F_p}$ (See~\cite[\S 5.3]{ribet-stein:serre}.) By
    Eicher-Shimura, $T_p = F+p/F\in \End(J_{/\F_p})$ so
    \[
    \tau(T_p X_s) 
    = T_p\tau(X_s) 
    = (F+p/F)\tau(X_s)
    = \tau((\Frob_p+p/\Frob_p)X_s)
    \subseteq \tau(X_s)
    \]
    hence, $T_p X_s\subseteq X_s$, as desired.
\end{proof}


\subsection{Non-Eisenstein modules are kernels of Hecke}%
\label{sub:non_eisenstein_modules_are_kernels_of_hecke}

In light of Section~\ref{sub:finite_odd_order_galois_modules_are_hecke}, all
odd $G_\QQ$-submodules of $J(\QQbar)$ are $\TT$-modules. We will now
use this fact freely and will often refer to the $\TT$-support of an odd
$G_\QQ$-submodule. We say an odd $G$-submodule is non-Eisenstein is its
support does not contain any Eisenstein primes.

The goal now is to identity the odd non-Eisenstein $G$-submodules of
$J(\QQbar)_\odd$ by their $\TT$-annihilators. Using
Theorem~\ref{thm:G_modules_are_Hecke}, we can already do this in the
irreducible case.
\begin{corollary}
    Let $\m$ be an odd non-Eisenstein maximal, if $M$ is a nonzero finite
    irreducible $G$-submodule of $A(\QQbar)$ supported only on $\m$, then
    $M=J[\m]$.
\end{corollary}
\begin{proof}
    By Lemma~\ref{lemma:cherry_street}, the annihilator of $M$ is $\m$. Hence,
    $M\subseteq J[\m]$ but $J[\m]$ is an irreducible
    $G$-module~\cite[Proposition 14.2]{mazur:eisenstein} so $M=J[\m]$.
\end{proof}

The general case will follow from the work of David Helm~\cite{helm:jacobian}.
Helm considers the case of Jacobians of Shimura curves but the relevant results
still apply mutatis mutandis.

\begin{theorem}[{\cite[Corollary 4.8]{helm:jacobian}}]%
    \label{thm:non_eisenstein_kernel_hecke}
    Let $M$ be a finite $G$-module supported only the non-Eisenstein primes of
    odd residue characteristic with $\TT$-annihilator $I$. Then $M=J[I]$.
\end{theorem}

We have that $V(I)=\Supp_\TT(M)$ and $M\subseteq J[I]$ so suffices to prove
$J[I]_\m = M_\m$ for each non-Eisenstein prime of odd residue characteristic.
So let $\m$ be a non-Eisenstein prime of residue characteristic $\ell>2$. Let
$T_\m J\isom \Hom(J[\m^\infty], \QQ_\ell/\ZZ_\ell)$ be the contravariant Tate
module at $\m$ and $\overline{\rho}_\m$ be the Galois representation associated
to $J[\m]^\vee$. Since $\m$ is an odd non-Eisenstein prime,
$\overline{\rho}_\m$ is an irreducible $G_\QQ$-representation of dimension 2
over $k_\m$ that is isomorphic to $J[\m]^\vee$~\cite[Prop.
14.2]{mazur:eisenstein}.

\begin{lemma}[{\cite[Lemma 4.6]{helm:jacobian}}]\label{lemma:finite_index}
    Let $M$ be a $G$-stable submodule of $T_\m J$ of finite index. Then
    $M=IT_\m J$ for some ideal $I$ of $\TT$.
\end{lemma}
\begin{proof}
    We proceed by induction on the maximal $G$-composition series of $T_\m J/M$
    with the base case being the trivial length zero case. Let 
    \[
        M = M_n \subsetneq M_{n-1} \subsetneq \cdots \subsetneq M_0 = T_\m J
    \]
    be a $G$-composition series. By induction, $M_{n-1} = I'T_\m J$ for some
    $I'\subseteq \TT$.

    Consider $\m M_{n-1} + M$. This is a $G$-module sitting between $M$ and
    $M_{n-1}$. By Nakayama's lemma, if $\m M_{n-1} M + M = M_{n-1}$, then
    $M=M_{n-1}$ which is a contradiction. Hence, $\m M_{n-1}+M=M$ so $M$
    contains $\m M_{n-1}$ and we can form the quotient.

    The module $M_{n-1}/\m M_{n-1}$ is $G$-isomorphic to $(I'/\m
    I')\otimes_{\TT/\m} (T_\m J/\m T_\m J) \cong (I'/\m I')\otimes_{\TT/\m}
    J[\m]^\vee$, where $G$ acts trivially on $I'/\m I'$. Let $V$ be the image
    of $M$ in $M_{n-1}/\m M_{n-1}$. Since $V$ is $G$-invariant, and
    $J[\m]^\vee$ is irreducible, $V$ is given by $\hat{V}\otimes J[\m]^\vee$
    for some $\TT/\m$-subspace $\hat{V}$ of $I'/\m I'$. Let $I$ be the preimage
    of $\hat{V}$ in $I'$. Then $IT_m J = M$, since both contain $\m M_{n-1}$
    and map to $V$ modulo $\m M_{n-1}$.
\end{proof}

We now return to the proof of the theorem.

\begin{proof}[proof of Theorem~\ref{thm:non_eisenstein_kernel_hecke}]
    Let $B=J/M$ be the quotient abelian variety equipped with the induced
    $\TT$-action. So the projection $\phi:J \to B$ is an $\TT[G_\QQ]$-isogeny
    with $\ker\phi = M$. For any odd non-Eisenstein prime $\m$, $\phi$ induces
    the exact sequence
    \[ 
        0 \to T_\m B \to T_\m J \to M^\vee _\m \to 0.
    \] 
    In particular, the image of $T_\m B$ under $\phi$ is a finite index
    $R$-submodule of $T_\m A$. By Lemma~\ref{lemma:finite_index}, we can find
    an ideal $I'$ of $\TT$ such that the image of $T_\m B$ is $I' _\m T_\m A$
    for all odd non-Eisenstein primes $\m$. We have $M^\vee _\m = T_\m J / I'
    T_\m J\cong J[I']_\m ^\vee$. Therefore, by taking annihilators of the dual,
    we have that $I_\m = I'_\m$ and then by taking duals $M_\m = J[I]_\m$, as
    desired.
\end{proof}

\subsection{Commutative algebra interlude}%
\label{sub:commutative_algebra_interlude}

\begin{lemma}\label{lem:com_alg}
    Let $a,b\in \TT_A$, $\p$ such the localization $(\TT_A)_\p$ is a DVR, and
    $M$ an odd finite $G$-submodule of $A(\QQbar)$ with $Z=\Ann M$. Then
    \begin{enumerate}
        \item 
            If $v_\p(Z) = k$, then $M[\p^\infty]\subseteq A[\p^k]$.
        \item
            We have $b^{-1}(A[Z])=A[bZ]$. This holds locally at $\p$ as well so
            $b_\p ^{-1} A[Z]_\p = A[bZ]_\p$.
        \item
            Let $r=v_\p(b)-v_\p(a)+k$ and $\phi=a\circ b^{-1}$. If $r\leq
            0$, then $\phi(M)[\p^\infty]=0$ so $\phi(M)_\p=0$.
            
            If $r>0$, then
            $\phi(M)[\p^\infty]\subseteq A[\p^r]$. Here $b^{-1}$ is the
            preimage of $b$.
    \end{enumerate}
    We will take on the convention that for negative $r$, $A[\p^r]=0$. So we can
    write the last part as $\phi(M)[\p]\subseteq A[\p^r]$.
\end{lemma}
\begin{proof}
    \mbox{}
    \begin{enumerate}
        \item 
            Suppose $x\in M[\p^\infty]$ so $x\in A[\p^\infty]$. Moreover,
            $v_\p(x) \leq v_\p(Z) = k$ so $x\in A[\p^k]$.
        \item
            We have $x\in b^{-1}(A[Z])$ if and only if $bx \in A[Z]$ if and
            only if $x\in A[bZ]$.
        \item
            Suppose $r\leq 0$, then $\phi_\p \in Z_\p$ so
            \[
                \phi(M)[p^\infty]\subseteq \phi(M[\p^\infty])
                \subseteq \phi(A[\p^k]) = 0.
            \]
            Suppose $r>0$ and then $x\in \phi(M)[\p^\infty] =
            \phi(M[\p^\infty])\subseteq (a\circ
            b^{-1})(A[\p^k])=A[\p^r]$.
    \end{enumerate}
\end{proof}

\subsection{Bounding support and valuations}%
\label{sub:bounding_support_and_valuations} 

The goal now is to compute an ideal $Q$ and a exponent $k$ such that
$\M(A[Q^k]) = \M(A(\QQbar)_\odd$.  

\begin{proposition}\label{prop:things_are_equivalent}
    Suppose $I,\q$ are ideals such that $bI = a\q$ for $a,b\in \TT_A ^\times$
    and $\phi=a\circ b^{-1}$. Then $A[I]\sim A[\q]$. Moreover, suppose $M'$ is a
    $G$-submodule of $A(\QQbar)$, then $A[I]+M'\sim
    A[\q]+\phi(M')$.
\end{proposition}
\begin{proof}
    Our argument will now reference the following diagram.
    \[
        \begin{tikzcd}
            A/A[bI] 
            \arrow[r, "\sim", "b"']
            \ar[equal]{d}
            &
            A/A[I]
            \arrow[r, "\psi"]
            \ar[d, "\sim" labl, "\phi"]
            &
            A/(A[I]+ M')
            \ar[d, "\sim" labl, "\phi'"]
            \\
            A/A[a \q]
            \arrow[r, "\sim", "a"']
            &
            A/A[\q]
            \arrow[r, "\psi'"]
            &
            A/(A[\q]+ \phi(M'))
        \end{tikzcd}
    \]
    We first establish the $b$ and $a$ isomorphism. We have the exact
    sequence
    \[
        \begin{tikzcd}
            0
            \arrow[r]
            &
            (A/A[I])[b]
            \arrow[hookrightarrow]{r}
            &
            A/A[I]
            \arrow[twoheadrightarrow]{r}{b}
            &
            A/A[I]
            \arrow[r]
            &
            0
        \end{tikzcd}.
    \]
    We have that $x\in (A/A[I])[b]$ if and only if $bx \in A[I]$ if and only if
    $x \in A[bI]$. Hence, $(A/A[I])[b]=A[bI]/A[I]$ so $b:A/A[bI]\xra{\sim}
    A[I]$. A similar argument applies for $a$. We need to be careful with what
    $b^{-1}$ means. A priori, we must take it to mean the preimage under $b$.
    However, it is well-defined as map from $A/A[I]\to A/A[bI]$.

    Let $\psi:A/A[I]\to A/(A[I]+ M')$ be the quotient map and
    $\phi=a\circ b^{-1}:A/A[I] \to A/A[\q]$. We have that $\phi(A[I]+
    M') = A[\q] + \phi(M')$. Now let $\psi':A/A[\q] \to
    A/(A[\q]+\phi(M'))$ be the quotient map and $\phi' = a\circ
    b^{-1}:A/(A[I]+ M')\to A/(A[\q]+\phi(M'))$. We also have
    $\phi'\circ \psi = \psi'\circ \phi$.
\end{proof}

We now immediately apply this proposition to help enumerate the isogeny class.
Suppose $2\nmid \mathfrak{f}$ or more generally, suppose there exists a set of
odd integral representatives $H=\{\q_i\}$ of $\Cl(\TT_A)$. Let
${S=S_1\cup\bigcup_{\q\in H}V(\q)}$ and $S'=\Spec \TT_A[\frac{1}{2}]\setminus S$.

\begin{corollary}%
    \label{cor:bound_support}
    Every finite odd $G$-submodule is equivalent to one supported on $S$.
\end{corollary}
\begin{proof}
    Let $M$ be a finite odd $G$-submodule. Let $M=M_{S'}\oplus M_S$ be the
    direct sum decomposition of $M$ with $\Supp M_X \subseteq X$. By
    Theorem~\ref{thm:non_eisenstein_kernel_hecke}, there exists an ideal
    $I$ of $\TT_A$ with $V(I)\subseteq S'$. Since $S'$ consists of only
    invertible primes, $I$ is also invertible. So there exists $a,b\in \TT_A
    ^\times$ and $\q\in \{\q_i\}$ such that $bI = a\q$.

    By Proposition~\ref{prop:things_are_equivalent}, $M\sim A[\q]+\phi(M_S)$.
    Let $\p\in S'$, then
    $v_\p(b)-v_\p(a)+v_\p(\Ann(M_S))=v_\p(\q)-v_\p(I)+v_\p(\Ann(M_S)) \leq 0$
    since $V(\q),V(\Ann(M_S))\subseteq S$. By Lemma~\ref{lem:com_alg},
    $\phi(M_S)_\p = 0$. Therefore, $A[\q]+\phi(M_S)$ is supported on $S$.
\end{proof}

We now will further assume that $\TT_A$ is integrally closed. As before, let
$H=\{\q_i\}$ be a set of integral representatives of $\Cl(\TT_A)$ of odd
residue characteristic, and let ${S=S_1\cup\bigcup_{\q\in H}V(\q)}$.

Let $Q = (\prod_{\q\in H} \q)(\prod_{\p\in S_1} \p)$. Since $V(Q)=S$, the finite
$G$-submodules supported on $S$ are exactly the finite $G$-submodules of
exactly the finite $G$-submodules of $A[Q^\infty]$. The goal now is to find $k$
such that 

\begin{corollary}
    \label{cor:set_of_reps}
    Suppose $\TT_A$ is integrally closed. Suppose $\M(A[Q^k])=\M(A[Q^{k+1})$
    then $\M(A[Q^k])=\M(A[Q^\infty])$.

    In terms of isogenies, this claim states that if $G$-submodules of
    $A[Q^{k+1}]$ produce no new odd-isogenies not found in $A[Q^k]$, then
    $G$-submodules of $A[Q^k]$ give the entire odd-isogeny class.
\end{corollary}
\begin{proof}
    Every isogeny can be factored into a composition of irreducible isogenies.
    Let $A'=A/M$ be a abelian variety with $M$ a $G$-submodule of $A[Q^k]$. We
    will show that the image of $A'$ under an irreducible isogeny is equivalent
    to $A/Y$ for some $Y\in A[Q^{k+1}]$. This suffices because when
    $A[Q^k]=A[Q^{k+1}]$, we obtain the full isogeny class.

    Let $M'\subseteq A(\QQbar)_\odd$ be an extension of $M$ by an irreducible
    $G$-module $Y$. Let $\m$ be the annihilator of $Y$. If $\m\in S$, then
    $M\subseteq A[\m Q^k]\subseteq A[Q^{k+1}]$ and we are done. So assume
    $\m\notin S$ so $\m$ is an odd Eisenstein prime and $Y=A[\m]$
    (Theorem~\ref{thm:irreducible_G_sub}). Since $\m\notin \Supp(M)$, $M' =
    A[\m]\oplus M$. Let $b\m=a\q$ with $a,b\in \TT_A$ and $\q\in \{\q_i\}$.
    Then $M'\sim A[\q] + \phi(M)$. The goal is to show $A[\q]+\phi(M)\subseteq
    A[Q^k]$. Since $A[\q]\subseteq A[Q^{k+1}]$ so it suffices to show
    $\phi(M)\subseteq A[Q^{k+1}]$.
    
    As in Corollary~\ref{cor:bound_support}, $\Supp\phi(M)\subseteq S$. For all
    $\p\in S$ (remember that $\m \notin S$), $v_\p(b)-v_\p(a) =
    v_\p(\q)-v_\p(\m)=v_\p(\q)$ so by Lemma~\ref{lem:com_alg},
    $\phi(M)\subseteq A[Q^{k+1}]$, as desired.
\end{proof}

\subsection{Enumerating isogenies}%
\label{sub:enumerating_isogenies}

In this section, we give an algorithm to enumerating the isogeny class of $A$
when $\TT_A$ is integrally closed. Using Corollary~\ref{cor:set_of_reps}, we
can determine $Q$ and $k$ such that the set of $G_\QQ$-submodules of $A[Q^k]$
is a set of representatives for $\M(A(\QQbar)_\odd)$. It remains to show how to
enumerate the $G_\QQ$-submodules of $A[Q^r]$. We have the direct sum
decomposition
\[
    A[Q^r]=\bigoplus_{\p\in V(Q)} A[\p^{rv_\p(Q)}]
\]
so it suffices to describe how to enumerate the $G$-submodules of $A[\p^s]$ for
any $s$. We will do this by induction. Mazur handles the $s=1$ case.


\begin{proposition}[Mazur]\label{prop:all_G_subs}
    Let $\p$ be a prime of residue characteristic $\ell>2$.
    \begin{enumerate}
        \item 
            If $\p$ is Eisenstein, then $A[\p]=C_A[\ell]\oplus \Sigma_A[\ell]$,
            where $C_A=C\cap A$ and $\Sigma_A=\Sigma \cap A$ with $C$ and
            $\Sigma$ the cuspidal and Shimura subgroups of $J$. The
            $G$-submodules of $A[\p]$ are the direct sum of $\ZZ$-submodules of
            $C_A[\ell]$ and $\ZZ$-submodules of $\Sigma_A[\ell]$.
        \item
            if $\p$ is non-Eisenstein, $A[\p]$ is irreducible~\cite[Prop
            14.2]{mazur:eisenstein} as as a $G_\QQ$-module so the only
            $G$-submodules are $0$ and $A[\p]$.
    \end{enumerate}
\end{proposition}
\begin{proof}
    The Eisenstein case is~\cite[Corollary 16.3]{mazur:eisenstein} along with
    the fact that $C[\ell]\isom \ZZ/\ell$ and $\Sigma[\ell]\isom \mu\ell$.

    The non-Eisenstein case is~\cite[Propositon 14.2]{mazur:eisenstein}.
\end{proof}

For reasons that'll soon become apparent, we also need to enumerate the
$G_\QQ$-submodules of $A[\p]^t$.
\begin{itemize}
    \item 
        If $\p$ is Eisenstein, then the Galois action on $C_A[\ell]$ is trivial
        and the Galois action on $\Sigma_A[\ell]$ is given by the cyclotomic
        character. So we know the Galois action explicitly on $A[\p]$ so the we
        know Galois action explicitly on $A[\p]^t$ so we can determine the
        $G_\QQ$-modules of $A[\p]^t$.
    \item
        If $\p$ is no Eisenstein, 
\end{itemize}


For the inductive step, we use a trick of Mazur~\cite[pg.
112]{mazur:eisenstein}. Let $s\geq 2$, and
$a_1,\ldots,a_t\in \p^s$ be a set of generators whose cosets generate
$\p^{s-1}/\p^s$ as a $k_\p$-vector space. Then there is an $R$-inclusion
\begin{align*}
    \phi_s: A[\p^s]/A[\p^{s-1}] & \to A[\p]^t, \\
    x+A[\p^{s-1}] & \mapsto (a_1x,\ldots,a_tx).
\end{align*}
The $G$-submodules of $A[\p^s]$ are the $\ZZ$-submodules $X$ of $A[\p^s]$ with
the property $\phi(X)$ is a $G$-submodule of $A[\p]^t$ and $X\cap A[\p^{s-1}]$
is a $G$-submodule of $A[\p^{s-1}]$. So by induction, we can determine the
$G$-submodules of $A[\p^s]$ for any $s$. 

\bibliography{biblio}
\end{document}
